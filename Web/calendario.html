<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
    
    <!--  ESTILOS  -->
    <link rel="stylesheet" href="estilos.css">              <!-- Hoja de estilos externa para general y barra superior -->
    <link rel="stylesheet" href="estilos_calendario.css">   <!-- Hoja de estilos externa para la p√°gina en concreto -->
    
    <!-- ----------------------------- LIBRER√çAS EXTERNAS ----------------------------------- -->
    <!-- Librer√≠a Leaflet para visualizaci√≥n de mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Fuente Inter desde Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!------------------------------ BARRA SUPERIOR DE NAVEGACI√ìN ------------------------------>
    <nav class="main-navigation">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="calendario.html" class="active">Calendario</a></li>
            <li><a href="chat.html">Chat</a></li>
            <li><a href="documentacion.html">Documentacion</a></li>
            <li><a href="citas.html">Citas</a></li>
        </ul>
    </nav>

    <!------------------------------ CONTENEDOR PRINCIPAL DE LA P√ÅGINA ------------------------------>
    <div class="main-content">

        <!-- --------------------------- COLUMNA IZQUIERDA: CALENDARIO ------------------------------>
        <div class="calendar-container">
            <div id="dynamicCalendar"></div>
            <div class="calendar-navigation">
                <button id="todayButton">Hoy</button>
                <button id="prevMonth">&lt;</button>
                <button id="nextMonth">&gt;</button>
            </div>
        </div>

        <!-- ----------------------------- COLUMNA CENTRAL: HORARIO -------------------------------->
        <div class="schedule">
            <!-- Cabecera con el t√≠tulo del d√≠a -->
            <div class="day-title">
                <div id="dayTitleCell"></div>
            </div>

            <!-- Columna con las horas -->
            <div class="hours-column"></div>

            <!-- Contenedor de tareas por hora -->
            <div class="task-container" id="taskContainer"></div>
        </div>

        <!-- ------------------------------ COLUMNA DERECHA: MAPA --------------------------------->
        <div class="map-container" id="map-container">
            <!-- Secci√≥n superior del mapa -->
            <div id="map-upper"></div>

            <!-- Secci√≥n inferior con detalles del recorrido -->
            <div id="route-container">
                <h3>Recorrido del d√≠a</h3>
                <div id="route-info"></div>
            </div>
        </div>
    </div>
    
    <!--******************************************************************************************************************************************************************************-->

    <script>
        // ------------------------- VARIABLES GLOBALES Y ELEMENTOS CLAVE -------------------------
        // Inicializa variables de fecha actual
        const today = new Date();                                              // Obtiene fecha actual
        const currentDay = today.getDate();                                    // Obtiene d√≠a actual
        let currentYear = today.getFullYear();                                 // Obtiene a√±o actual
        let currentMonth = today.getMonth();                                   // Obtiene mes actual
        
        // Obtiene referencias a botones de navegaci√≥n
        const prevMonthButton = document.getElementById('prevMonth');          // Bot√≥n mes anterior
        const nextMonthButton = document.getElementById('nextMonth');          // Bot√≥n mes siguiente
        const todayButton = document.getElementById('todayButton');            // Bot√≥n hoy
        

        // ----------------------------- FUNCI√ìN PARA ELIMINAR MENSAJE DE "NO HAY EVENTOS" -----------------------------
        function removeNoEventsMessage() {
            const existingMessage = document.querySelector('.no-events-message'); // Busca el mensaje existente
            if (existingMessage) {                                               // Si existe
                existingMessage.parentNode.removeChild(existingMessage);         // Lo elimina del DOM
            }
        }
        
        
        // ---------------------------- FUNCI√ìN PARA CREAR HORARIO VAC√çO (HORAS + LIMPIEZA) ----------------------------
        function createEmptySchedule(year, month, day) {
            const taskContainer = document.getElementById('taskContainer');    // Obtiene el contenedor de tareas
            const hoursColumn = document.querySelector('.hours-column');       // Obtiene la columna de horas
            taskContainer.innerHTML = "";                                      // Limpia el contenedor de tareas
            hoursColumn.innerHTML = "";                                        // Limpia la columna de horas
            
            const hours = Array.from({ length: 14 }, (_, i) => 8 + i);         // Crea un array con horas de 8 a 21
            hours.forEach(hour => {                                            // Para cada hora
                const hourCell = document.createElement('div');                // Crea una celda
                hourCell.classList.add('hour-cell');                           // Le a√±ade la clase correspondiente
                hourCell.textContent = `${hour}:00`;                           // Establece el texto de la hora
                hoursColumn.appendChild(hourCell);                             // A√±ade la celda a la columna
            });
            
            clearMap();                                                        // Limpia tambi√©n el mapa
        }


        // -------------------------- FUNCI√ìN PARA CREAR CELDAS DE HORA EN LA COLUMNA IZQUIERDA --------------------------
        function createEmptyHours() {
            const hoursColumn = document.querySelector('.hours-column');       // Obtiene la columna de horas
            hoursColumn.innerHTML = "";                                        // Limpia el contenido previo
            const hours = Array.from({ length: 14 }, (_, i) => 8 + i);         // Crea un array con las horas de 8 a 21
            hours.forEach(hour => {                                            // Para cada hora
                const hourCell = document.createElement('div');                // Crea una celda
                hourCell.classList.add('hour-cell');                           // Le a√±ade la clase correspondiente
                hourCell.textContent = `${hour}:00`;                           // Establece el texto de la hora
                hoursColumn.appendChild(hourCell);                             // A√±ade la celda a la columna
            });
        }
        

        // ----------------------------- FUNCI√ìN PARA LIMPIAR EL MAPA Y MOSTRAR PLACEHOLDER -----------------------------
        function clearMap() {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = `
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 500px; padding: 2rem; text-align: center;">
                    <div style="font-size: 3rem;">üó∫Ô∏è</div>
                    <p style="margin-top: 1rem; font-size: 0.95rem; color: var(--color-secondary);">
                        El recorrido del d√≠a aparecer√° aqu√≠ cuando haya tareas programadas.
                    </p>
                </div>
            `;
        }



        // ---------------------- FUNCI√ìN PARA FORMATEAR UNA DIRECCI√ìN COMPLETA A PARTIR DE CAMPOS ----------------------
        function normalizarDireccion(direccion, poblacion, cp, provincia) {
            if (!direccion || !poblacion || !cp || !provincia) return "";

            let dir = direccion.trim();

            // Reemplazar abreviaturas comunes
            dir = dir.replace(/^C\/|^c\/|^Calle\/|^calle\./i, "Calle ");
            dir = dir.replace(/^Avda\.?|^Av\.?/i, "Avenida ");
            dir = dir.replace(/^Plza\.?|^Plz\.?/i, "Plaza ");
            dir = dir.replace(/\s{2,}/g, ' '); // Elimina espacios m√∫ltiples

            return `${dir}, ${cp}, ${poblacion}, ${provincia}`;
        }

        
        // -------------------------- FUNCI√ìN PARA CARGAR Y DIBUJAR EL MAPA CON RUTAS Y CLIENTES --------------------------
        async function loadMap(horarios) {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = `
                <div id="map-upper"></div>
                <div id="route-container">
                    <h3>Recorrido del d√≠a</h3>
                    <div id="route-info"></div>
                </div>
            `;

            const map = L.map('map-upper');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const bounds = [];
            const locationData = [];
            const promises = [];

            horarios.forEach((item, index) => {
                const direccionNormalizada = normalizarDireccion(item.direccion, item.poblacion, item.cp, item.provincia);
                const location = direccionNormalizada;
                if (location.trim() !== "") {
                    promises.push(getCoordinates(location));
                    locationData.push({
                        eventNum: index + 1,
                        client: item.descripcion,
                        timeRange: item.hora,
                        reason: item.estado,
                        direccion: item.direccion,
                        poblacion: item.poblacion,
                        cp: item.cp,
                        provincia: item.provincia,
                        location
                    });
                }
            });

            const coordinatesArray = await Promise.all(promises);

            for (let i = 0; i < locationData.length; i++) {
                const coordinates = coordinatesArray[i];
                if (coordinates) {
                    locationData[i].coordinates = coordinates;
                    L.marker(coordinates).addTo(map)
                        .bindPopup(`<strong>${locationData[i].client}</strong><br>${locationData[i].reason}<br>${locationData[i].location}`)
                        .bindTooltip(locationData[i].eventNum.toString(), { permanent: true, direction: 'center' });

                    bounds.push(coordinates);
                }
            }

            if (bounds.length > 0) {
                map.fitBounds(L.latLngBounds(bounds));
            } else {
                map.setView([40.4168, -3.7038], 6);
            }

            const routeInfo = document.getElementById('route-info');
            routeInfo.innerHTML = '';

            if (locationData.length < 2) {
                routeInfo.innerHTML = '<p class="text-center">No hay suficientes ubicaciones para mostrar un recorrido.</p>';
                return;
            }

            for (let i = 0; i < locationData.length - 1; i++) {
                const current = locationData[i];
                const next = locationData[i + 1];
                if (current.coordinates && next.coordinates) {
                    const routeData = await getRoute(current.coordinates, next.coordinates);
                    if (routeData) {
                        const routeStyle = {
                            color: '#4f5d75',
                            weight: 4,
                            opacity: 0.7,
                            dashArray: '5, 10'
                        };
                        L.geoJSON(routeData.route, { style: routeStyle }).addTo(map);

                        const segmentEl = document.createElement('div');
                        segmentEl.className = 'route-segment';
                        segmentEl.innerHTML = `
                            <div class="segment-number">${i + 1}</div>
                            <div class="segment-info">
                                <div class="segment-location">De: ${current.direccion}, ${current.poblacion}</div>
                                <div class="segment-location">A: ${next.direccion}, ${next.poblacion}</div>
                                <div class="segment-details">
                                    <span class="route-time">${routeData.duration} min</span>
                                    <span class="route-distance">${routeData.distance} km</span>
                                </div>
                            </div>
                        `;
                        routeInfo.appendChild(segmentEl);
                    }
                }
            }
        }


        // ------------------------------- FUNCI√ìN PARA OBTENER COORDENADAS CON NOMINATIM -------------------------------
        async function getCoordinates(location) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`); // Realiza la petici√≥n
                const data = await response.json();                            // Convierte la respuesta a JSON
                if (data && data.length > 0) {                                 // Si hay datos
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)]; // Devuelve latitud y longitud
                } else {
                    console.warn(`No se encontraron coordenadas para: ${location}`); // Avisa si no hay resultados
                    return null;                                               // Devuelve null
                }
            } catch (error) {
                console.error('Error al obtener coordenadas:', error);         // Muestra error si falla
                return null;                                                   // Devuelve null
            }
        }
        
        
        // --------------------------- FUNCI√ìN PARA OBTENER UNA RUTA ENTRE DOS PUNTOS CON OSRM ---------------------------
        async function getRoute(start, end) {
            try {
                // Formato de la API OSRM: lon,lat (invertido respecto a Leaflet)
                const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code !== 'Ok') {
                    throw new Error('No se pudo calcular la ruta');
                }
                
                return {
                    route: data.routes[0].geometry,
                    distance: (data.routes[0].distance / 1000).toFixed(1),  // km
                    duration: Math.round(data.routes[0].duration / 60)      // minutos
                };
            } catch (error) {
                console.error('Error al obtener la ruta:', error);
                return null;
            }
        }


       // --------------------------------- FUNCI√ìN PARA GENERAR LA VISTA DE CALENDARIO ---------------------------------
        function generateCalendar(year, month, day, selectedDay) {
            const firstDay = new Date(year, month, 1);                         // Obtiene el primer d√≠a del mes
            const lastDay = new Date(year, month + 1, 0);                      // Obtiene el √∫ltimo d√≠a del mes
            const daysInMonth = lastDay.getDate();                             // Obtiene el n√∫mero de d√≠as en el mes
            let startingDay = firstDay.getDay();                               // Obtiene el d√≠a de la semana del primer d√≠a
            
            startingDay = (startingDay === 0) ? 6 : startingDay - 1;           // Ajusta para que lunes sea 0
            
            const calendarDiv = document.getElementById('dynamicCalendar');     // Obtiene el div del calendario
            calendarDiv.innerHTML = '';                                        // Limpia el contenido anterior
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; // Nombres de los meses
            const monthName = monthNames[month];                               // Obtiene el nombre del mes actual
            
            let calendarHTML = `<h2>${monthName} ${year}</h2><table><tr><th>Lun</th><th>Mar</th><th>Mi√©</th><th>Jue</th><th>Vie</th><th>S√°b</th><th>Dom</th></tr><tr>`; // Estructura HTML
            
            let dayCounter = 1;                                                // Contador de d√≠as
            for (let i = 0; i < 6; i++) {                                      // Bucle para 6 semanas
                for (let j = 0; j < 7; j++) {                                  // Bucle para 7 d√≠as
                    if (i === 0 && j < startingDay) {                          // Si es celda vac√≠a inicial
                        calendarHTML += '<td></td>';                           // Celda vac√≠a
                    } else if (dayCounter <= daysInMonth) {                    // Si es un d√≠a v√°lido
                        let dayCellClass = '';                                 // Clase para la celda
                        if (dayCounter === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) { // Si es hoy
                            dayCellClass = 'today-cell';                       // Clase para hoy
                        }
                        if (selectedDay && dayCounter === selectedDay && month === currentMonth && year === currentYear) { // Si es seleccionado
                            dayCellClass += ' selected-day';                   // Clase para seleccionado
                        }
                        calendarHTML += `<td class="${dayCellClass}" data-day="${dayCounter}">${dayCounter}</td>`; // Celda con d√≠a
                        dayCounter++;                                          // Incrementa contador
                    } else {
                        calendarHTML += '<td></td>';                           // Celda vac√≠a final
                    }
                }
                calendarHTML += '</tr><tr>';                                   // Fin de fila
            }
            
            calendarHTML += '</tr></table>';                                   // Cierra tabla
            calendarDiv.innerHTML = calendarHTML;                              // Actualiza el HTML
            
            const dayCells = calendarDiv.querySelectorAll('td[data-day]');     // Obtiene celdas con d√≠as
            dayCells.forEach(cell => {                                         // Para cada celda
                cell.addEventListener('click', () => {                         // A√±ade evento clic
                    const clickedDay = parseInt(cell.dataset.day);             // Obtiene d√≠a clicado
                    const fechaStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${clickedDay.toString().padStart(2, '0')}`;
                    loadSchedule(fechaStr, year, month, clickedDay);           // Carga horario
                    generateCalendar(year, month, day, clickedDay);            // Regenera calendario
                });
            });
        }


        // -------------------------------------- FUNCI√ìN PARA CARGAR EL HORARIO --------------------------------------
        async function loadSchedule(fecha, year, month, day) {
            try {
                removeNoEventsMessage();

                const dayTitleCell = document.getElementById('dayTitleCell');
                const taskContainer = document.getElementById('taskContainer');
                const hoursColumn = document.querySelector('.hours-column');

                const nombresDias = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
                const nombresMeses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
                const fechaObj = new Date(year, month, day);
                const nombreDia = nombresDias[fechaObj.getDay()];
                const nombreMes = nombresMeses[month];
                const formattedDate = `${nombreDia}, ${day} de ${nombreMes} de ${year}`;
                dayTitleCell.textContent = formattedDate;

                const response = await fetch(`/api/horarios?fecha=${fecha}`);
                if (!response.ok) {
                    createEmptySchedule();
                    return;
                }

                const horarios = await response.json();

                if (!Array.isArray(horarios) || horarios.length === 0) {
                    createEmptySchedule();
                    const noEventsMessage = document.createElement('div');
                    noEventsMessage.classList.add('no-events-message');
                    noEventsMessage.innerHTML = "No hay eventos programados para este d√≠a.";
                    document.querySelector('.schedule').appendChild(noEventsMessage);
                    clearMap();
                    return;
                }

                // Limpiar y construir columnas base
                taskContainer.innerHTML = "";
                hoursColumn.innerHTML = "";
                const hours = Array.from({ length: 14 }, (_, i) => 8 + i); // de 8 a 21
                hours.forEach(hour => {
                    const hourCell = document.createElement('div');
                    hourCell.classList.add('hour-cell');
                    hourCell.textContent = `${hour}:00`;
                    hoursColumn.appendChild(hourCell);
                });

                // Construir bloques de tareas
                horarios.forEach((item, index) => {
                    const [hourStr, minuteStr] = item.hora.split(':');
                    const hora = parseInt(hourStr);
                    const minuto = parseInt(minuteStr);
                    const duracion = parseInt(item.duracion);

                    const startTime = ((hora - 8) * 4) + Math.floor(minuto / 15);
                    const rowSpan = Math.ceil(duracion / 15);
                    const startRow = startTime + 1;

                    // Descripci√≥n
                    const clientCell = document.createElement('div');
                    clientCell.classList.add('task-cell');
                    clientCell.style.gridRow = `${startRow} / span ${rowSpan}`;
                    clientCell.style.gridColumn = '1';
                    clientCell.innerHTML = `<strong>${item.descripcion}</strong>`;

                    // Direcci√≥n (solo l√≠nea de direcci√≥n)
                    const direccionCell = document.createElement('div');
                    direccionCell.classList.add('task-cell');
                    direccionCell.style.gridRow = `${startRow} / span ${rowSpan}`;
                    direccionCell.style.gridColumn = '2';
                    direccionCell.textContent = item.nombre || '';

                    // Poblaci√≥n + Provincia
                    const ubicacionCell = document.createElement('div');
                    ubicacionCell.classList.add('task-cell');
                    ubicacionCell.style.gridRow = `${startRow} / span ${rowSpan}`;
                    ubicacionCell.style.gridColumn = '3';
                    ubicacionCell.textContent = `${item.poblacion} (${item.provincia})`;

                    taskContainer.appendChild(clientCell);
                    taskContainer.appendChild(direccionCell);
                    taskContainer.appendChild(ubicacionCell);
                });


                // Cargar mapa si fuera necesario
                loadMap(horarios); 
            } catch (error) {
                console.error("Error al cargar el horario:", error);
            }
        }

        
        // ------------------------------- INICIALIZACI√ìN DE LA P√ÅGINA Y EVENTOS -------------------------------
        // Asegura que el mapa est√© vac√≠o al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {             // Al cargar el DOM
            clearMap();                                                        // Limpia el mapa
        });
        
        // Eventos para botones de navegaci√≥n
        prevMonthButton.addEventListener('click', () => {                      // Al hacer clic en mes anterior
            currentMonth--;                                                    // Decrementa mes
            if (currentMonth < 0) {                                            // Si es menor que 0
                currentMonth = 11;                                             // Establece diciembre
                currentYear--;                                                 // Decrementa a√±o
            }
            generateCalendar(currentYear, currentMonth, currentDay, null);     // Regenera calendario
        });
        
        nextMonthButton.addEventListener('click', () => {                      // Al hacer clic en mes siguiente
            currentMonth++;                                                    // Incrementa mes
            if (currentMonth > 11) {                                           // Si es mayor que 11
                currentMonth = 0;                                              // Establece enero
                currentYear++;                                                 // Incrementa a√±o
            }
            generateCalendar(currentYear, currentMonth, null);                 // Regenera calendario
        });
        
        todayButton.addEventListener('click', () => {
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            const day = now.getDate();

            const fechaStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            generateCalendar(currentYear, currentMonth, day, day);  // ‚Üê actualiza el calendario y selecciona el d√≠a
            loadSchedule(fechaStr, currentYear, currentMonth, day); // ‚Üê carga datos del d√≠a
        });
        
        // Inicializaci√≥n del calendario y horario
        generateCalendar(currentYear, currentMonth, currentDay, currentDay);   // Genera calendario inicial
        const fechaInicial = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${currentDay.toString().padStart(2, '0')}`;
        loadSchedule(fechaInicial, currentYear, currentMonth, currentDay);
    </script>
</body>
</html>